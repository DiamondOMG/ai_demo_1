<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>Browser STT & TTS Full Chunk (Auto Stop)</title>
    <style>
      body {
        margin: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        font-family: Arial, sans-serif;
      }
      #start {
        width: 100%;
        height: 100vh;
        font-size: 24px;
        background-color: #4caf50;
        color: white;
        border: none;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      #start:hover {
        background-color: #45a049;
      }
      #result {
        margin-top: 20px;
        font-size: 18px;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <h2>ðŸŽ¤ Browser Speech-to-Text & Text-to-Speech</h2>
    <button id="start">Start</button>
    <div id="result"></div>

    <script>
      const SpeechRecognition =
        window.SpeechRecognition || window.webkitSpeechRecognition;
      const recognition = new SpeechRecognition();
      const synth = window.speechSynthesis;

      recognition.lang = "th-TH";
      recognition.continuous = true;
      recognition.interimResults = false;

      const resultDiv = document.getElementById("result");
      const startButton = document.getElementById("start");
      let silenceTimer;

      // WebSocket connection
      const ws = new WebSocket("ws://localhost:8001");

      recognition.onresult = (event) => {
        const transcript =
          event.results[event.results.length - 1][0].transcript;
        resultDiv.innerText = transcript;

        // à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸œà¹ˆà¸²à¸™ WebSocket
        ws.send(
          JSON.stringify({
            type: "stt",
            message: transcript,
          })
        );

        clearTimeout(silenceTimer);
        silenceTimer = setTimeout(() => {
          recognition.stop();
          startButton.style.backgroundColor = "#4CAF50";
        }, 2000);
      };

      recognition.onerror = (e) => {
        console.error("Error:", e.error);
        startButton.style.backgroundColor = "#4CAF50";
      };

      recognition.onend = () => {
        console.log("Recognition stopped.");
        startButton.style.backgroundColor = "#4CAF50";
      };

      startButton.onclick = () => {
        resultDiv.innerText = "";
        recognition.start();
        startButton.style.backgroundColor = "#ff4444";
      };

      // à¸£à¸±à¸š event à¸ˆà¸²à¸ server
      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === "wakeword" && data.status === "detected") {
          resultDiv.innerText = "";
          recognition.start();
          startButton.style.backgroundColor = "#ff4444";
        } else if (data.type === "output" && data.message) {
          // à¹ƒà¸Šà¹‰ Web Speech API à¸ªà¸³à¸«à¸£à¸±à¸š Text-to-Speech
          const utterance = new SpeechSynthesisUtterance(data.message);
          utterance.lang = "th-TH";
          synth.speak(utterance);
          resultDiv.innerText = data.message;
        }
      };
    </script>
  </body>
</html>