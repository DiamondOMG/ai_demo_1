<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>Browser STT & TTS Split UI</title>
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }
      .container {
        display: flex;
        flex: 1;
        width: 100%;
      }
      .panel {
        flex: 1;
        padding: 20px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      .stt-panel {
        background-color: #f0f8ff;
      }
      .tts-panel {
        background-color: #fff0f5;
      }
      h2 {
        text-align: center;
        margin: 10px 0;
      }
      button {
        padding: 15px 30px;
        font-size: 18px;
        border: none;
        cursor: pointer;
        transition: background-color 0.3s;
        border-radius: 5px;
      }
      #start {
        background-color: #4caf50;
        color: white;
      }
      #start:hover {
        background-color: #45a049;
      }
      #start.recording {
        background-color: #ff4444;
      }
      #tts-button {
        background-color: #2196f3;
        color: white;
        margin-top: 10px;
      }
      #tts-button:hover {
        background-color: #1976d2;
      }
      #result,
      #tts-output {
        margin: 20px 0;
        font-size: 18px;
        text-align: center;
        min-height: 50px;
      }
      #tts-input {
        width: 80%;
        padding: 10px;
        font-size: 16px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      #voice-select {
        width: 80%;
        padding: 10px;
        font-size: 16px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
    </style>
  </head>
  <body>
    <h2>üé§ Browser Speech-to-Text & Text-to-Speech</h2>
    <div class="container">
      <div class="panel stt-panel">
        <h3>Speech-to-Text</h3>
        <button id="start">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <div id="result"></div>
      </div>
      <div class="panel tts-panel">
        <h3>Text-to-Speech</h3>
        <select id="voice-select"></select>
        <input
          type="text"
          id="tts-input"
          placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö)"
        />
        <button id="tts-button">‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
        <div id="tts-output"></div>
      </div>
    </div>

    <script>
      const SpeechRecognition =
        window.SpeechRecognition || window.webkitSpeechRecognition;
      const recognition = new SpeechRecognition();
      const synth = window.speechSynthesis;

      recognition.lang = "th-TH";
      recognition.continuous = true;
      recognition.interimResults = false;

      const resultDiv = document.getElementById("result");
      const startButton = document.getElementById("start");
      const ttsInput = document.getElementById("tts-input");
      const ttsButton = document.getElementById("tts-button");
      const ttsOutput = document.getElementById("tts-output");
      const voiceSelect = document.getElementById("voice-select");
      let silenceTimer;

      // Populate voice options
      function populateVoices() {
        const voices = synth
          .getVoices()
          .filter((voice) => voice.lang === "th-TH");
        voiceSelect.innerHTML = "";
        voices.forEach((voice, index) => {
          const option = document.createElement("option");
          option.value = index;
          option.text = voice.name + (voice.default ? " (Default)" : "");
          voiceSelect.appendChild(option);
        });
      }

      // Load voices (may need delay for some browsers)
      synth.onvoiceschanged = populateVoices;
      populateVoices();

      function ai_speak(text) {
        const inputText = text || ttsInput.value || "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö";
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(inputText);
        utterance.lang = "th-TH";
        utterance.volume = 1.0;
        utterance.rate = 1.0;
        const voices = synth
          .getVoices()
          .filter((voice) => voice.lang === "th-TH");
        if (voices.length > 0) {
          utterance.voice = voices[voiceSelect.value || 0];
        }
        window.speechSynthesis.speak(utterance);
        ttsOutput.innerText = inputText;
      }

      // WebSocket connection
      const ws = new WebSocket("ws://localhost:8001");

      recognition.onresult = (event) => {
        const transcript =
          event.results[event.results.length - 1][0].transcript;
        resultDiv.innerText = transcript;

        // Send message via WebSocket
        ws.send(
          JSON.stringify({
            type: "stt",
            message: transcript,
          })
        );

        clearTimeout(silenceTimer);
        silenceTimer = setTimeout(() => {
          recognition.stop();
          startButton.classList.remove("recording");
        }, 2000);
      };

      recognition.onerror = (e) => {
        console.error("Error:", e.error);
        startButton.classList.remove("recording");
      };

      recognition.onend = () => {
        console.log("Recognition stopped.");
        startButton.classList.remove("recording");
      };

      startButton.onclick = () => {
        resultDiv.innerText = "";
        recognition.start();
        startButton.classList.add("recording");
      };

      ttsButton.onclick = () => {
        ai_speak();
      };

      // Handle WebSocket messages
      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === "wakeword" && data.status === "detected") {
          resultDiv.innerText = "";
          recognition.start();
          startButton.classList.add("recording");
        } else if (data.type === "output" && data.message) {
          ai_speak(data.message);
        }
      };
    </script>
  </body>
</html>
